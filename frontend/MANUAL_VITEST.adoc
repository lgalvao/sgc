= Vitest Manual for SGC Project
:toc: left
:source-highlighter: highlight.js

This manual provides a concise introduction to Vitest in the context of the SGC project. It uses actual examples from the codebase to demonstrate common patterns and practices.

== Quick Start

Vitest is a blazing fast unit test framework powered by Vite. In this project, it is configured to run tests in a `jsdom` environment, simulating a browser.

=== Running Tests

Tests are executed via `npm` scripts defined in `package.json`:

[source,bash]
----
# Run all unit tests
npm run test:unit

# Run tests with coverage report
npm run coverage:unit
----

You can also run a specific test file directly:

[source,bash]
----
npx vitest frontend/src/stores/__tests__/processos.spec.ts
----

== Anatomy of a Test

Tests are structured using `describe` blocks to group related tests, and `it` (or `test`) blocks for individual test cases. `expect` is used for assertions.

.Example: `frontend/src/stores/__tests__/processos.spec.ts`
[source,typescript]
----
import { describe, it, expect } from "vitest";

describe("useProcessosStore", () => { // Group
    it("deve inicializar com o estado padrÃ£o", () => { // Test case
        // Setup (often done in beforeEach)
        const store = useProcessosStore();

        // Assertion
        expect(store.processosPainel).toEqual([]);
        expect(store.processoDetalhe).toBeNull();
    });
});
----

== Mocking

Mocking is essential to isolate the unit under test. We use `vi` from `vitest` for all mocking needs.

=== Mocking Modules & Services

Use `vi.mock()` to mock external dependencies like API services or other stores. This is typically done at the top of the file.

.Example: `frontend/src/stores/__tests__/processos.spec.ts`
[source,typescript]
----
import { vi } from "vitest";

// Mock entire service modules
vi.mock("@/services/painelService");
vi.mock("@/services/processoService");

// Mock other stores (Pinia)
vi.mock("../unidades", () => ({ useUnidadesStore: vi.fn(() => ({})) }));
----

=== Mocking Functions (Spies)

Use `vi.fn()` to create a mock function that tracks calls.

.Example: `frontend/src/views/__tests__/ProcessoView.spec.ts`
[source,typescript]
----
const pushMock = vi.fn(); // Create a spy

vi.mock("vue-router", () => ({
    useRouter: () => ({
        push: pushMock, // Inject the spy
    }),
    // ... other mocks
}));

// Assertion
expect(pushMock).toHaveBeenCalledWith({
    name: "Subprocesso",
    params: { codProcesso: "1", siglaUnidade: "U1" },
});
----

=== Spying on Methods

Use `vi.spyOn()` to spy on a method of an existing object.

.Example: `frontend/src/views/__tests__/ProcessoView.spec.ts`
[source,typescript]
----
const { wrapper, feedbackStore } = createWrapper();
const spy = vi.spyOn(feedbackStore, "show"); // Spy on 'show' action

// Trigger action
wrapper.findComponent(ModalFinalizacaoStub).vm.$emit("confirmar");

// Assert
expect(spy).toHaveBeenCalled();
----

== Component Testing

We use `@vue/test-utils` to mount components.

=== Mounting Components

Use `mount` to render the component. You can pass `props`, `global` plugins (like Pinia), and `stubs`.

.Example: `frontend/src/components/__tests__/BarraNavegacao.spec.ts`
[source,typescript]
----
import { mount } from "@vue/test-utils";
import BarraNavegacao from "../BarraNavegacao.vue";

const wrapper = mount(BarraNavegacao, {
    global: {
        plugins: [createTestingPinia({ createSpy: vi.fn })], // Integrate Pinia
        stubs: {
            RouterLink: RouterLinkStub, // Stub router-link
            BButton: true, // Shallow render BButton
        },
    },
});
----

=== Finding Elements

Use `wrapper.find()` or `wrapper.findComponent()` to locate elements.

.Example: `frontend/src/components/__tests__/AtividadeItem.spec.ts`
[source,typescript]
----
// Find by class
const botoesContainer = wrapper.find(".botoes-acao-atividade");
expect(botoesContainer.exists()).toBe(true);

// Find by component type (or Stub)
const modal = wrapper.findComponent(ModalFinalizacaoStub);
----

=== Triggering Events

Use `trigger` for DOM events or `$emit` for component events.

.Example: `frontend/src/views/__tests__/ProcessoView.spec.ts`
[source,typescript]
----
// Trigger DOM click
await wrapper.find("button").trigger("click");

// Emit custom event from a child component
const acoes = wrapper.findComponent(ProcessoAcoesStub);
acoes.vm.$emit("finalizar");
----

== Store Testing (Pinia)

Pinia stores are tested in isolation. We often use `initPinia` helper or `createTestingPinia`.

=== Setup

.Example: `frontend/src/stores/__tests__/processos.spec.ts`
[source,typescript]
----
import { initPinia } from "@/test-utils/helpers";

describe("useProcessosStore", () => {
    let store: ReturnType<typeof useProcessosStore>;

    beforeEach(async () => {
        initPinia(); // Reset Pinia before each test
        store = useProcessosStore();
        // ... set up mocks
    });
});
----

=== Testing Actions

Call the action and assert the state change or service call.

.Example: `frontend/src/stores/__tests__/processos.spec.ts`
[source,typescript]
----
it("deve chamar o processoService", async () => {
    // Setup mock return
    processoService.criarProcesso.mockResolvedValue({} as any);

    // Call action
    await store.criarProcesso(payload);

    // Assert
    expect(processoService.criarProcesso).toHaveBeenCalledWith(payload);
});
----

== Common Patterns

=== Async Updates (`flushPromises`)

Vue updates are asynchronous. Use `flushPromises` to wait for DOM updates or pending promises to resolve.

.Example: `frontend/src/views/__tests__/ProcessoView.spec.ts`
[source,typescript]
----
import { flushPromises } from "@vue/test-utils";

it("deve renderizar dados no mount", async () => {
    createWrapper();
    await flushPromises(); // Wait for lifecycle hooks and async calls

    expect(processoService.obterDetalhesProcesso).toHaveBeenCalled();
});
----

=== Hoisted Mocks

If you need to use a variable inside `vi.mock()`, you must use `vi.hoisted()`.

.Example: `frontend/src/views/__tests__/ProcessoView.spec.ts`
[source,typescript]
----
const { pushMock } = vi.hoisted(() => {
    return { pushMock: vi.fn() };
});

vi.mock("vue-router", () => ({
    useRouter: () => ({ push: pushMock }), // Use the hoisted variable
}));
----

=== Mocking `vue-router`

Since we use `useRoute` and `useRouter` composables, we mock the module `vue-router` directly.

.Example: `frontend/src/components/__tests__/BarraNavegacao.spec.ts`
[source,typescript]
----
vi.mock("vue-router", () => ({
    useRoute: vi.fn(), // Mock useRoute to return different routes in tests
    useRouter: () => ({ back: vi.fn() }), // Mock useRouter
    createRouter: vi.fn(),
    createWebHistory: vi.fn(),
}));

// In a test:
vi.mocked(useRoute).mockReturnValue({ path: "/login", ... });
----
