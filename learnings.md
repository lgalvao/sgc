# Learnings from Fixing CDU-03 E2E Tests

This document summarizes the debugging process, root causes, and solutions applied to fix the failing E2E tests in the `cdu-03.spec.ts` file.

## 1. Initial Problem

The initial request was to fix the failing tests for `cdu-03`. The first run showed multiple failures with a variety of error messages, including backend database errors and frontend timeouts.

## 2. Investigation & Root Cause Analysis

The debugging process involved several steps to isolate and understand each failure.

### Issue 1: Backend Schema Not Found
- **Symptom**: The backend logs showed a `org.h2.jdbc.JdbcSQLSyntaxErrorException: Schema "SGC" not found` error. This prevented any data from being saved or retrieved, causing most of the tests to fail with timeouts on the frontend.
- **Investigation**:
    1. I confirmed that the `Unidade` entity and others were correctly annotated with `@Table(schema = "sgc")`.
    2. I examined the E2E database configuration (`E2eDatabaseConfig.java` and `E2eTestDatabaseService.java`), which is responsible for creating isolated in-memory H2 databases for each test.
    3. The setup was intended to create the `SGC` schema, but the error indicated this was failing for the isolated test-specific databases.
    4. Adding debug logs confirmed the schema *was* being created at first, but subsequent Hibernate access failed. This pointed to an issue with how the database scripts were being executed.

### Issue 2: Test Logic Bugs
- **Symptom**: After fixing the initial database schema issue, some tests still failed with timeouts or `ReferenceError`.
- **Investigation**:
    1. Using the `error-context.md` file generated by Playwright was crucial. It showed a snapshot of the page at the moment of failure.
    2. For one test, the snapshot revealed a "Dados incompletos: Preencha a data limite" error alert. I inspected the test code and found that it was calling `clicarBotaoSalvar()` without filling in the mandatory `dataLimite` field.
    3. For other tests, the error was `ReferenceError: page is not defined`. The test functions were defined as `async () =>` instead of `async ({ page }) =>`, so the Playwright `page` fixture was not being injected.

### Issue 3: Table Not Found
- **Symptom**: Even with the schema being created, a new error appeared: `Table "USUARIO_PERFIL" not found`.
- **Investigation**:
    1. This indicated that the `schema.sql` script was not being executed correctly or completely.
    2. I reviewed the `executeSqlScripts` method in `E2eTestDatabaseService.java` and identified it as a fragile, manual implementation that read a file and split it by semicolons. This method is prone to errors.
    3. I also inspected `schema.sql` and found a duplicate, incorrect `CREATE TABLE` statement for `usuario_perfil`, which was a clear bug.

### Issue 4: Incorrect Test Selectors
- **Symptom**: After fixing the database issues, the test for removing a process failed because it found the process name on the page when it expected it to be gone.
- **Investigation**:
    1. The Playwright error message was very helpful: `strict mode violation: getByText(...) resolved to 2 elements`.
    2. It found the process name in both the (now hidden) table row and the "Processo removido" toast notification.
    3. The test assertion `expect(this.page.getByText(descricao)).not.toBeVisible()` was too broad.
    4. Similarly, another test was failing to find a "Confirmar" button in a modal. Inspecting the component code (`CadProcesso.vue`) revealed the button in the removal confirmation modal was actually named "Remover".

## 3. Solutions Implemented

1.  **Database Script Execution**: The manual `executeSqlScripts` method in `E2eTestDatabaseService` was replaced with the robust `ScriptUtils.executeSqlScript` from the Spring Framework. This ensured that the `schema.sql` and `data-minimal.sql` files were executed reliably.
2.  **Database Configuration**: The JDBC URL for the isolated H2 databases was updated to include `MODE=PostgreSQL`. This improves compatibility with the production database (PostgreSQL), especially regarding identifier case-sensitivity.
3.  **SQL Schema Cleanup**: The duplicate and incorrect `CREATE TABLE sgc.usuario_perfil` statement was removed from `schema.sql`.
4.  **Test Helper Correction**: The `aguardarProcessoNoPainel` helper in `painel-page.ts` was modified to remove a workaround that was hiding the redirection bug. The test now properly fails if the application does not redirect after a successful save.
5.  **Test Case Fixes (`cdu-03.spec.ts`)**:
    *   Added the missing `preencherDataLimite()` calls to all tests that create a process.
    *   Added the `{ page }` fixture argument to the test functions that were causing a `ReferenceError`.
    *   Created a new, specific helper method (`confirmarRemocaoNoModal`) to click the "Remover" button in the correct modal, fixing the wrong button text issue.
    *   Scoped the `verificarProcessoNaoVisivel` helper to only search within the process table, ignoring the toast notification.

## 4. Key Learnings

-   **Don't Reinvent the Wheel**: The brittle manual SQL script runner was a key source of instability. Using established library functions (`ScriptUtils`) is more reliable and robust.
-   **Read the Full Error**: Playwright's error messages, especially strict mode violations and the path to `error-context.md`, are incredibly valuable for pinpointing the exact cause of a UI test failure.
-   **Specificity is Key**: Test selectors should be as specific as possible to avoid ambiguity. Scoping a search within a specific container (`tabela.getByText(...)`) is better than a global search (`page.getByText(...)`).
-   **Isolate the Problem**: Running a single failing test (`npx playwright test -g "Test Name"`) is much more efficient than running the whole suite and wading through logs.
-   **Test Your Tests**: The tests themselves had bugs (missing required data). When a test fails, the application isn't always the culprit. The `error-context.md` was vital in discovering this.
-   **Database Consistency**: When using an in-memory database (H2) for tests against a production database (PostgreSQL), it's important to be mindful of compatibility settings. Adding `MODE=PostgreSQL` caused case-sensitivity issues with the existing SQL scripts, while removing it and relying on H2's default behavior proved to be the correct path for this project.
-   **Teardown Race Conditions**: Cleaning up resources (like a database) immediately after each test can cause race conditions if there are in-flight requests. Disabling the post-test cleanup and relying on the final `globalTeardown` to terminate the entire backend process was a safe way to resolve this, as test isolation was already guaranteed by using uniquely named databases.
-   **Interpret Logs in Context**: An "ERROR" or "WARN" in the logs doesn't always indicate a bug. The final `WARN` message about `ErroProcesso` was from a test specifically designed to trigger a validation error. The log showed the system correctly handling the error path, which meant the test was successful.

## 5. Final Code State

After all fixes, the final state of the key modified files is as follows:

-   **`e2e/cdu/cdu-03.spec.ts`**: All tests now have the required data (`dataLimite`) and correct fixture arguments (`{ page }`). The removal test uses a more specific helper method.
-   **`e2e/helpers/pages/painel-page.ts`**: The `verificarProcessoNaoVisivel` method is now correctly scoped to the processes table. The `aguardarProcessoNoPainel` no longer hides redirection bugs.
-   **`e2e/helpers/pages/processo-page.ts`**: Contains a new `confirmarRemocaoNoModal` method for handling the specific "Remover" confirmation.
-   **`e2e/support/fixtures.ts`**: The automatic database cleanup after each test is disabled to prevent teardown race conditions.
-   **`backend/src/main/resources/schema.sql`**: The duplicate `usuario_perfil` table definition has been removed.
-   **`backend/src/main/java/sgc/e2e/E2eTestDatabaseService.java`**: Now uses the robust `ScriptUtils` for SQL execution and a clean H2 JDBC URL.
