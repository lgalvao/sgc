    private void notificarTransicao(Subprocesso sp, TipoTransicao tipo,
                                    @org.jspecify.annotations.Nullable Unidade origem,
                                    @org.jspecify.annotations.Nullable Unidade destino,
                                    @org.jspecify.annotations.Nullable String observacoes) {
        try {
            if (tipo.geraAlerta()) {
                String sigla = sp.getUnidade().getSigla();
                String descricao = tipo.formatarAlerta(sigla);
                alertaService.criarAlertaTransicao(sp.getProcesso(), descricao, origem, destino);
            }
            if (tipo.enviaEmail()) {
                notificarMovimentacaoEmail(sp, tipo, origem, destino, Objects.requireNonNullElse(observacoes, ""));
            }
        } catch (Exception e) {
            log.error("Falha ao enviar notificação de movimentação {}: {}", tipo, e.getMessage(), e);
        }
    }

    private void notificarMovimentacaoEmail(Subprocesso sp, TipoTransicao tipo,
                                            @org.jspecify.annotations.Nullable Unidade unidadeOrigem,
                                            @org.jspecify.annotations.Nullable Unidade unidadeDestino,
                                            String observacoes) {
        if (!tipo.enviaEmail()) return;

        try {
            // Se o destino for nulo, usamos a unidade do subprocesso como fallback para notificação direta
            Unidade destinoEfetivo = unidadeDestino != null ? unidadeDestino : sp.getUnidade();
            
            Map<String, Object> variaveis = criarVariaveisTemplateDireto(sp, unidadeOrigem, destinoEfetivo, observacoes);
            enviarNotificacaoDireta(sp, tipo, destinoEfetivo, variaveis);

            if (tipo.notificacaoSuperior() && unidadeOrigem != null) {
                enviarNotificacaoSuperior(unidadeOrigem, sp, tipo, variaveis, destinoEfetivo);
            }
        } catch (Exception e) {
            log.error("Erro ao processar comunicações da movimentação {}: {}", tipo, e.getMessage(), e);
        }
    }

    private String getEmailUnidade(Unidade unidade) {
        String sigla = unidade.getSigla();
        return (sigla != null ? sigla.toLowerCase() : "desconhecida") + "@tre-pe.jus.br";
    }

    private void enviarNotificacaoDireta(Subprocesso sp,
                                         TipoTransicao tipo,
                                         Unidade unidadeDestino,
                                         Map<String, Object> variaveis) {

        String assunto = criarAssunto(tipo, sp, false);
        String corpo = processarTemplate(tipo.getTemplateEmail(), variaveis);

        String emailUnidade = getEmailUnidade(unidadeDestino);
        emailService.enviarEmailHtml(emailUnidade, assunto, corpo);

        log.info("Notificação operacional {} enviada para {}", tipo, unidadeDestino.getSigla());
        notificarResponsavelPessoal(unidadeDestino, assunto, corpo, tipo);
    }

    private void notificarResponsavelPessoal(Unidade unidade, String assunto, String corpo, TipoTransicao tipo) {
        UnidadeResponsavelDto responsavel = organizacaoFacade.buscarResponsavelUnidade(unidade.getCodigo());
        if (responsavel != null && responsavel.substitutoTitulo() != null) {
            usuarioFacade.buscarUsuarioPorTitulo(responsavel.substitutoTitulo())
                    .ifPresent(u -> {
                        if (!u.getEmail().isBlank()) {
                            emailService.enviarEmailHtml(u.getEmail(), assunto, corpo);
                            log.info("Notificação operacional '{}' enviada a e-mail pessoal de {}", tipo, u.getNome());
                        }
                    });
        }
    }

    private void enviarNotificacaoSuperior(Unidade unidadeOrigem,
                                           Subprocesso sp,
                                           TipoTransicao tipo,
                                           Map<String, Object> variaveisBase,
                                           Unidade unidadeJaNotificada) {

        Unidade superior = unidadeOrigem.getUnidadeSuperior();
        String assunto = criarAssunto(tipo, sp, true);

        while (superior != null) {
            if (superior.getCodigo().equals(unidadeJaNotificada.getCodigo())) {
                superior = superior.getUnidadeSuperior();
                continue;
            }
            try {
                Map<String, Object> variaveis = new HashMap<>(variaveisBase);
                variaveis.put("siglaUnidadeSuperior", superior.getSigla());

                String corpo = processarTemplate(tipo.getTemplateEmailSuperior(), variaveis);
                String emailSuperior = getEmailUnidade(superior);

                emailService.enviarEmailHtml(emailSuperior, assunto, corpo);
                log.info("Notificação de acompanhamento {} enviada para unidade {}", tipo, superior.getSigla());
            } catch (Exception e) {
                log.warn("Falha ao notificar unidade superior {}: {}", superior.getSigla(), e.getMessage());
            }
            superior = superior.getUnidadeSuperior();
        }
    }

    private Map<String, Object> criarVariaveisTemplateDireto(Subprocesso sp,
                                                             @org.jspecify.annotations.Nullable Unidade unidadeOrigem, Unidade unidadeDestino,
                                                             @org.jspecify.annotations.Nullable String observacoes) {
        Map<String, Object> variaveis = new HashMap<>();

        variaveis.put("siglaUnidade", sp.getUnidade().getSigla());
        variaveis.put("nomeUnidade", sp.getUnidade().getNome());

        if (unidadeOrigem != null) {
            variaveis.put("siglaUnidadeOrigem", unidadeOrigem.getSigla());
            variaveis.put("nomeUnidadeOrigem", unidadeOrigem.getNome());
        } else {
            variaveis.put("siglaUnidadeOrigem", "N/A");
            variaveis.put("nomeUnidadeOrigem", "N/A");
        }

        variaveis.put("siglaUnidadeDestino", unidadeDestino.getSigla());
        variaveis.put("nomeUnidadeDestino", unidadeDestino.getNome());

        variaveis.put("nomeProcesso", sp.getProcesso().getDescricao());
        variaveis.put("tipoProcesso", sp.getProcesso().getTipo().name());

        if (sp.getDataLimiteEtapa1() != null) {
            variaveis.put("dataLimiteEtapa1", sp.getDataLimiteEtapa1().format(DATE_FORMATTER));
        }

        if (sp.getDataLimiteEtapa2() != null) {
            variaveis.put("dataLimiteEtapa2", sp.getDataLimiteEtapa2().format(DATE_FORMATTER));
            variaveis.put("dataLimiteValidacao", sp.getDataLimiteEtapa2().format(DATE_FORMATTER));
        }

        if (observacoes != null) {
            variaveis.put("observacoes", observacoes);
        }

        return variaveis;
    }

    private String criarAssunto(TipoTransicao tipo, Subprocesso sp, boolean paraSuperior) {
        String base = tipo.getDescMovimentacao();

        return paraSuperior
                ? "SGC: %s - %s".formatted(base, sp.getUnidade().getSigla())
                : "SGC: %s".formatted(base);
    }

    private String processarTemplate(String templateName, Map<String, Object> variables) {
        Context context = new Context();
        context.setVariables(variables);
        return templateEngine.process(templateName, context);
    }
}
